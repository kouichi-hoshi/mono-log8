---
title: 04. 作業計画書
source:
author:
  -
published:
created: 2025-11-25
description:
tags:
---
# フェーズ0
- cursor設定
	- [AGENTS.md](http://AGENTS.md)を設定する
# フェーズ1
## フェーズ1のゴール
- **スタブモードでUIの一通りの操作が確認できる状態**（Vercelデモ用デプロイ可能）

## フェーズ1の進め方（画面ベース）
- まず **画面（ビュー）定義に沿って UI/レイアウトを組み上げ**、次に **スタブ/モックで機能を代替**し、最後に **テスト（Red→Green→Refactor）**で担保する。
- 推奨の進行順は **画面A（未ログイン）→ 画面B（ログイン中タイムライン）→ 画面C（ゴミ箱）→ 画面D（横断UI）**。
- ただし実行順は固定ではなく、`docs/05. 作業計画進行チェックリスト.md` の **前提ID（依存関係）を満たすことを最優先**とする。
- フェーズ1では原則として **各画面（ビュー）は単体で完了（解釈1）**とし、画面間の導線・状態保持などの **連携確認は専用タスクとして切り出す**（例: スタブログイン後の画面切替）。

### リスク管理（フェーズ1）
- 認証スタブは `/api/auth/stub` + HTTP-only Cookie でセッションを保持するため、ブラウザの開発者ツールから値を確認できる。**P1-RSK-01** でドキュメント整備と環境変数ガードを徹底し、開発/テスト専用で運用する。
- フェーズ2で Auth.js（Google OAuth）を導入する際（`P2-AUTH-01`）にスタブ Cookie を完全に撤去し、本番と同じ仕組みに差し替えてリスクを排除する。

#### P1-RSK-01: 認証スタブ運用ガードの詳細

**目的**: スタブ認証が開発環境でのみ動作し、本番環境やCI環境で誤って有効化されないことを保証する。

**実装内容**:
1. `lib/auth/constants.ts` で `USE_STUB_AUTH` を定義し、`NODE_ENV !== "production"` をチェック
2. `lib/authAdapter/server.ts` / `client.ts` でスタブ認証関数にガードを追加
3. `app/api/auth/stub/route.ts` の Route Handler にガードを追加（403を返す）
4. `docs/03. 設計書.md` に運用ガードの詳細を追記
5. `docs/04. 作業計画書.md` にリスク管理の説明を追記
6. `docs/05. 作業計画進行チェックリスト.md` に完了条件を記載

**確認方法**:
- 本番環境（`NODE_ENV=production`）で `/api/auth/stub` にアクセスすると 403 が返る
- CI 環境（`NODE_ENV=test`）でスタブ認証が無効化されている
- 開発環境でのみスタブ認証が動作する

## 1-0. 基盤（画面実装の前提）
- 開発環境構築
	- フレームワーク、ライブラリをインストールする
		- `03. 設計書`「採用技術・構成技術」を参照
- テスト基盤
	- Jest + React Testing Library をセットアップし、`pnpm test` がGREENになる
- UI基盤
	- TailwindCSS + shadcn/ui を初期化し、必要なUIコンポーネントを追加できる状態にする
	- UIコンポーネントは原則として **shadcn/ui の CLI で追加して利用する（手動実装を避ける）**
		- 追加コマンド（例）
			- `pnpm dlx shadcn@latest add button`
			- `pnpm dlx shadcn@latest add dialog`
			- `pnpm dlx shadcn@latest add alert`
			- `pnpm dlx shadcn@latest add alert-dialog`
			- `pnpm dlx shadcn@latest add checkbox`
			- `pnpm dlx shadcn@latest add popover`
			- `pnpm dlx shadcn@latest add sonner`
			- `pnpm dlx shadcn@latest add spinner`
		- 完了条件
			- `components/ui/*` は shadcn CLI で生成されたものを採用し、アプリ側は `@/components/ui/*` をインポートして利用していること
			- 追加要件（例: スピナーのフェード演出）がある場合は、公式実装を直接改変しすぎず、ラッパー（例: `SpinnerWithFade`）として拡張すること
- 外観（テーマ）基盤（next-themes）
	- フェーズ1の段階で **ThemeProvider を導入して土台だけ整備**する（切替UIは作らない）
	- 例: `ThemeProvider attribute="class" defaultTheme="system" enableSystem`
	- `sonner` の Toaster は `useTheme()` を利用するため、ThemeProvider 配下で動作させること
- スタブ切替の接続ポイント
	- 環境変数でスタブ/本番を切替える `authAdapter` / `postRepository` を用意する（本番ではスタブ無効ガード）
- 画面分岐の前提
	- Server Component（例: `app/page.tsx`）で「未ログイン／ログイン中」の表示分岐ができる（土台はスタブセッションで可）

## 1-A. 画面A（未ログイン）: UI → スタブ導線 → テスト
- レイアウト
	- ヘッダー（アプリ名＋ログインボタン）
	- メイン（ウェルカムメッセージ＋ログインボタン＋このアプリについて＋免責事項＋Link）
	- フッター（コピーライト）
	- 表示テキストは `06. 表示テキスト定義.md` を参照
- 認証UI（スタブでOK）
	- ログインボタン押下でモーダル表示、「Googleでログイン」ボタン、閉じる操作（×/背景）
	- 「Googleでログイン」ボタン押下で **スタブ認証処理（イベント）が発火**する（画面切替の確認は 1-B の範囲で行う）
- テスト（TDD）
	- 未ログイン時の表示要素（Header/Main/Footer）と、モーダル開閉がGREEN

## 1-B. 画面B（ログイン中タイムライン）: UI → スタブCRUD配線 → テスト
- レイアウト・表示切替UI
	- ヘッダー
		- md以上: 表示切替（センター）＋ユーザーアイコン（右）＋ログアウトリンクポップオーバー
		- md未満: ユーザーアイコン（右）
	- メイン（エディタ固定＋投稿一覧、md以上は左右分割でエディタを固定）
	- 表示切替（md以上: ヘッダー内 / md未満: 画面下部に固定。「ごみ箱を見る」リンクを含む）
	- フッター（ログイン中は非表示）
- 各モードとゴミ箱はクエリパラメータで保持する（`mode` / `view`。設計書参照）
	- すべて表示も `mode=all` として明示する（`/` は利用しない）
- ユーザーアイコン（Popover）
	- ユーザー名表示、ログアウト導線
	- （日記モードはフェーズ2で実装する）
- 投稿エディタ（スタブでOK）
	- モードチェック（メモ/ToDo、初期値メモ）
	- 保存/更新ボタン（未入力はAlert）
	- 保存/更新後は クリア＋フォーカス＋sonner通知（保存/更新）
	- 編集時のみキャンセル
- 投稿一覧（スタブでOK）
	- 初期ロード: 直近10件を更新日降順で表示、Skeletonローディング表示あり
	- 各投稿要素: モード/投稿日/更新日/本文/ゴミ箱アイコン/編集ボタン（インライン編集差し替え）
	- ソートUI: G1（更新順/投稿順）× G2（昇順/降順）
		- 「手動順」は手動並び替え機能（フェーズ2）に依存するため除外
	- 手動並び替え（上下ボタン、ドラッグ＆ドロップ）は **フェーズ2** で実装する
	- 無限スクロール（スタブ）: IntersectionObserver で 100px 手前を検知し、postRepository スタブから次の10件を取得。取得時のSkeleton表示、全件取得メッセージ、レイアウトシフト防止を TDD で担保する
- テスト（TDD）
	- ログイン中の表示要素、表示切替、エディタ保存/更新、一覧の編集/ゴミ箱投入がGREEN

## 1-C. 画面C（ゴミ箱ビュー）: UI → スタブ配線 → テスト
- 表示切替・ゴミ箱ビュー
	- ゴミ箱表示 `view=trash`（通常一覧のキャッシュは保持して復元できる想定）
- ゴミ箱の操作（スタブでOK）
	- 選択（個別/一括）
	- 復元（status=activeに戻す）
	- 完全削除（確認モーダルあり）
	- ゴミ箱を空にする（一括削除、確認モーダルあり）
	- 文言は `06. 表示テキスト定義.md` を参照
- テスト（TDD）
	- trashedのみ表示、選択UI、復元/削除/空にするの挙動がGREEN

## 1-D. 画面D（横断UI・品質）: UI → 開発用シミュレーション → テスト
- エラーハンドリング・フィードバック
	- sonner/アラートの表示を共通化する
	- 開発環境のみ `?errorTest=...` でsonner各種通知を表示し、表示後はクエリ除去（本番では無効）
- ローディング表示
	- shadcn の Skeleton コンポーネントを使用し、投稿一覧のローディング中は投稿のプレースホルダーを表示してレイアウトシフトを防ぐ
	- ローディング中は実データを非表示にし、Skeletonのみを表示する
- テスト（TDD）
	- `?errorTest=...` の動作（開発のみ）と本番無効化がGREEN

# フェーズ2
- DB接続
- ユーザー認証（Route Handlers を利用し Auth.js で本番接続）
- タイムライン機能の拡張
	- 投稿の手動並び替え（上下ボタン／ドラッグ&ドロップ）＋永続化（本番DB）
	- 手動順ソート（手動並び替え機能に依存）
	- 無限スクロールを本番の DB + Server Actions + TanStack Query で実現する
- アカウント管理
	- アカウント削除機能（DB のユーザーデータ削除、セッション終了、完了メッセージ表示）
- タグ
	- 投稿保存時のタグ付与（初期値 null、基本的な追加／削除／ラベル編集）に加え、表示切替UIから複数タグで絞り込めるクエリパラメータ／キャッシュ連携を整備する
- 日記モード
	- ユーザーアイコンPopoverのトグルで日記モードON/OFFを切替（ユーザー設定として永続化）
	- 日記モード有効時のみ「日記」ボタンを表示し、「すべて」は日記を含む
	- 日記モード有効時のみ、投稿モードとして「日記」を選択できる
- テストの充実
	- 認証（Route Handlers）、DB（Prisma）、無限スクロール、ソート、タグを含む単体・結合テストを追加する
	- 詳細なテスト内容は 03. 設計書の「テスト戦略」を参照

# フェーズ3
- 外観変更（システム／ライト／ダーク、文字サイズの変更）
	- フェーズ1で導入した ThemeProvider 基盤を前提に、**切替UI（system/light/dark）＋文字サイズスケール UI（normal/large/xlarge）＋永続化（User.fontScale + localStorage）＋回帰テスト**を実装する

# フェーズ4
- 検索・整理機能の強化
	- テキスト検索（タイトル／本文／モード／タグを対象）
- タグ機能の拡張
	- カスタムタグ追加／編集／削除
	- タグ削除時の挙動（タグが付いていた投稿は「タグ未登録」とする）
- 投稿のライフサイクル管理
	- ゴミ箱投入日から一定日数経過後の自動削除
- 投稿エクスポート（検討）
	- 具体的なエクスポート形式・操作は今後検討（ToDo）

※ 各フェーズの詳細な画面仕様・要件は `02. 要件定義書.md`、内部構造・テスト方針は `03. 設計書.md` を参照すること。
