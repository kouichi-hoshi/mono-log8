---
title: 07. 運用手順（CI・デプロイ）
created: 2025-12-27
description: GitHub Actions / Vercel / Neon（PostgreSQL）を前提に、マイグレーション適用とデプロイを安全に運用するための手順書
---

## 目的

- `docs/03. 設計書.md` の方針（GitHub Actions で `prisma migrate deploy` → Vercel Deploy Hook）を、**実行手順として再現可能**にする
- `docs/05. 作業計画進行チェックリスト.md` の `P2-CI-01/02` を、チェックリストから辿って実施できる状態にする

## 前提（方針の参照先）

- 方針（Why/What）: `docs/03. 設計書.md`
- 進捗チェック（Done条件）: `docs/05. 作業計画進行チェックリスト.md`

## 重要な注意（禁止事項）

- **本番DBに対して `prisma migrate dev`（マイグレーションの作成）は実行しない**
  - 本番は **`prisma migrate deploy`（適用のみ）** を使う
- 秘匿情報（APIキー/トークン/パスワード等）は **ドキュメントに書かない／コードにハードコードしない**
- local/CI/stg/prod のSecretsの登録先は分離する（詳細は「Secretsの登録先」）

## 用語（最小）

- **Migration（Prisma）**: `prisma/migrations` 配下にコミットされる差分（= DB構造変更の履歴）
- **Deploy Hook（Vercel）**: HTTPリクエストでデプロイをトリガーするURL

## Secretsの登録先（責務分離）

- **local**: `.env.local`（gitignore前提）
- **CI（GitHub Actions）**: GitHub Secrets
- **stg/prod（Vercel）**: Vercel Environment Variables

## 必要な環境変数（例）

### DB

- `DATABASE_URL`
  - アプリ実行（pool/PgBouncer）向け
- `DATABASE_DIRECT_URL`
  - マイグレーション実行（direct）向け（CIで利用する想定）

### 認証（Auth.js）

- `AUTH_SECRET`
- `GOOGLE_CLIENT_ID`
- `GOOGLE_CLIENT_SECRET`

### デプロイ

- `VERCEL_DEPLOY_HOOK_URL`
  - GitHub Actions から Vercel Deploy Hook を叩くために使用

## 運用フロー（開発→本番）

### 1) 開発（ローカル）でマイグレーションを作成する

- Prisma schema を変更する
- ローカルDBに対してマイグレーションを **作成・適用**する
  - 例: `prisma migrate dev`
- 生成された `prisma/migrations` をコミットする

**完了条件（目安）**
- `prisma/migrations` に差分が追加されている
- アプリがローカルで動作し、関連テストがGREEN

### 2) リリース（main反映）で本番へ適用する（CI）

**狙い**
- main のコードと本番DB構造の不整合を避けるため、デプロイ前に `prisma migrate deploy` を適用する

**手順（概念）**
- main へマージ/Push する
- GitHub Actions が起動し、以下を行う
  - `prisma migrate deploy` を実行（差分がある場合のみ）
  - 成功後に Vercel Deploy Hook を実行してデプロイ

**完了条件（目安）**
- GitHub Actions の実行ログで、migrate/deploy hook が成功している
- Vercel 側で新しいデプロイが作成され、アプリが起動している

## GitHub Actions（実装時のチェックポイント）

このRunbookは「どう作るべきか」の観点を提供する。実際のworkflowファイルの配置・名称はリポジトリ運用に合わせる。

- **配置**: `.github/workflows/` 配下に置く（例: `.github/workflows/deploy.yml`）
- **トリガー（推奨）**
	- `push`（`main` のみ）
	- 必要に応じて `workflow_dispatch`（手動実行）を追加
- **事故防止のガード（推奨）**
	- **同時実行の抑止**: `concurrency` で `main` へのデプロイを直列化する（並行デプロイ禁止）
	- **失敗時停止**: `prisma migrate deploy` が失敗したら **デプロイを実行しない**
	- **環境保護**: GitHub Environments（例: `production`）を使い、必要なら承認者を設定する
	- **fork対策（必要に応じて）**: Deploy Hook や DB へ触る job は、権限のあるリポジトリ/ブランチのみで走るように条件を付ける

- **順序**: migrate deploy → deploy
- **安全策**: 「差分がある場合のみ migrate」は、**“未適用マイグレーションがある場合のみ実際に適用される”**という意味で担保する
	- `prisma migrate deploy` は未適用が無い場合は **no-op** になるため、差分検知を自前実装せずに安全性を確保できる
- **失敗時**: migrate が失敗したら deploy を止める（途中デプロイ禁止）
- **Secrets**: `DATABASE_DIRECT_URL` と `VERCEL_DEPLOY_HOOK_URL` を GitHub Secrets に置く

### GitHub Actions 実装の最小要件（チェックリスト）

- `DATABASE_DIRECT_URL` を **CI用のGitHub Secrets** から環境変数として渡している
- `prisma migrate deploy` が **Deploy Hook より先**に実行される
- `prisma migrate deploy` が失敗した場合に **Deploy Hook を叩かない**
- Deploy Hook の実行は `curl` などで **HTTPステータスが失敗ならjobを失敗**させる
- 同時実行が直列化されている（`concurrency`）

### GitHub Actions 実装例（骨子・値はダミー）

※この例は「事故が起きないための構造」を示す。URLやシークレット値は埋め込まない。

```yaml
name: deploy
on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  migrate_and_deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          corepack enable
          pnpm install --frozen-lockfile

      - name: Prisma migrate deploy (apply only)
        env:
          DATABASE_DIRECT_URL: ${{ secrets.DATABASE_DIRECT_URL }}
        run: |
          pnpm prisma migrate deploy

      - name: Trigger Vercel Deploy Hook
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        run: |
          curl -fsSL "$VERCEL_DEPLOY_HOOK_URL"
```

#### 補足（差分がある場合のみ）

- `prisma migrate deploy` は **未適用マイグレーションがある場合だけ適用される**ため、結果として「差分がある場合のみ実行」と同等の運用になる。
- もし “migrateが無いときはスキップしたい” のような要件が出た場合でも、差分検知の自前実装よりまず **no-op運用**を優先する（事故を増やしにくい）。

## Vercel Deploy Hook（実装時のチェックポイント）

- Deploy Hook のURLは秘匿扱い（GitHub Secretsへ）
- 叩く対象（prod/stg/preview）の区別を明確化する

## トラブルシューティング（最小）

- **migrate deploy が失敗する**
  - `DATABASE_DIRECT_URL` が正しいか
  - 既存DB状態と migrations の整合が取れているか（ローカルだけで作成した未コミット差分がないか）
- **デプロイは成功したのにアプリが落ちる**
  - migrate が実行されていない/失敗している可能性（ActionsログとVercelログを確認）


