---
title: 40. タグ-お気に入り（設計書V2）
source:
author:
  -
published:
created: 2026-01-30
description:
tags:
---

本ファイルは設計書V1（アーカイブ済み）から、タグ/お気に入りに関する章を分割したもの。

## この章で決めること

- タグの識別子（`tagId` / `label`）と URL への載せ方
- タグラベルの正規化・バリデーション（適用ポイント含む）
- 絞り込み（tags/favorite）の意味と UI ルール（取得条件の優先順位はURL章を参照）

## この章の守備範囲

- タグ/お気に入りの意味、正規化ルール、編集UIの振る舞いを扱う
- URLスキームや正規化（canonical化）の詳細は扱わない（URL章を参照）

## 関連ドキュメント（参照先）

- URLスキーム/正規化/effective filters: `docs/03.v2/10_URL-状態管理.md`
- 投稿編集（タグ編集の配置など）: `docs/03.v2/30_投稿-編集-本文形式.md`

# タグ / お気に入り

本アプリでは、投稿に「タグ」と「お気に入り」を付与でき、投稿一覧ではそれらで絞り込みできる。

## タグの識別子（tagId / label）

- `tagId`: タグの主キー（DB）であり、URL の `tags=<tagId>` に載せる識別子
  - 生成: 本番（Prisma）は `cuid()`、開発スタブは `randomUUID()` を使用する（ID形式に依存しない設計とする）
- `label`: ユーザーが入力・表示するタグ名（UIの正）
- URL には `label` を載せず、常に `tagId` を載せる（共有URLの安定性のため）
- 投稿の保存/更新時は、入力された `label` を正規化したうえで `ownerId + label` で既存検索し、`tagId` を解決する（なければ作成）
- URL に含まれる `tagId` がタグクラウド（表示対象）に存在しない場合（未使用で非表示/削除/未同期等）でも、ユーザーが詰まらないよう「絞り込み解除（tags/favorite を全解除）」の導線を提供する（「投稿検索 > 絞り込み解除」参照）

## タグクラウド/候補の表示方針

- タグクラウド（既存タグ一覧）およびサジェストの候補は、「少なくとも1件の `status=active` 投稿に紐づく Tag」のみを表示する（未使用タグは DB に残すが UI には表示しない）
- ユーザーが未使用タグの `label` を入力して保存した場合は、既存 Tag があれば再利用され、付与後に候補へ現れる

## URL反映（tags/favorite）

- 投稿一覧の絞り込み状態は URL に反映する
  - タグ: `tags=<tagId>`（複数指定）
  - お気に入り: `favorite=1`
- URL スキーム/正規化、および `view=trash` 時の有効な取得条件（effective filters）は `docs/03.v2/10_URL-状態管理.md` を参照する

## 投稿エディタでのタグ編集

- タグボタン押下でタグ入力 UI（アコーディオン）を開閉する
- タグクラウド（既存タグ一覧）
  - 表示範囲は「タグクラウド/候補の表示方針」に従う
  - ボタン押下で編集対象の投稿にタグを追加/除去する（投稿は複数タグを持てる）
- タグ入力（新規/既存）
  - 入力中に既存タグをサジェストし、選択でタグを追加する
  - 追加したタグはチップとして表示し、チップ押下で除去できる
  - 新規タグは保存/更新時に作成し、完了後にタグクラウドへ反映される

## タグ ラベルの正規化・制約

### 適用ポイント

| 対象 | 適用場所（正） | 備考 |
| --- | --- | --- |
| タグの作成/解決（`label` → `tagId`） | 保存/更新の Server Action | クライアントからの `label` は参考にしても、そのまま採用しない |
| 入力補助（任意） | クライアント | 先行でエラー表示してUXを上げてもよいが、サーバー側判定が最終 |

### 正規化ルール（`normalizeTagLabel`）

| ルール | 入力例 | 出力例 | 目的/備考 |
| --- | --- | --- | --- |
| Unicode NFKC で正規化 | `ｶﾀｶﾅ` | `カタカナ` | 全角/半角や互換文字の揺れを減らす |
| 制御文字を除去 | `foo\u0007bar` | `foobar` | 表示崩れ・不可視文字混入を防ぐ |
| 空白を圧縮してトリム | `  foo\t\nbar  ` | `foo bar` | `\\s+` を半角スペース1つに寄せ、前後を削除する |
| 1行化（改行を保持しない） | `foo\nbar` | `foo bar` | タグチップ/ボタン表示を前提に「常に1行」を保証する |

### バリデーション（正規化後）

| 条件 | 代表ステータス | UI | 状態 | 備考 |
| --- | --- | --- | --- | --- |
| 空（`""`） | 422 | Alert | 維持 | 文言/詳細は「エラー通知実装設計」 |
| 32 文字超 | 422 | Alert | 維持 | 文字数は `label.length`（実装で統一） |

### 同一性・競合時の扱い

| 観点 | ルール |
| --- | --- |
| 大小文字 | 区別する。例: `React` と `react` は別タグ |
| 同一性（同名扱い） | `ownerId + label`（正規化後 `label`）の完全一致 |
| DB制約 | `ownerId + label` にユニーク制約 |
| 同時実行 | ユニーク制約違反が発生した場合は既存 Tag を再取得して吸収する |

## 投稿一覧：絞り込み

- タグクラウド
  - 押下で `tags` を URL に反映し、選択されたタグを含む投稿のみを表示する
  - アクティブにできるタグは複数（タグ押下で追加、アクティブなタグ押下で解除）
  - 選択タグが 0 件になった場合、タグ絞り込みは解除される
- お気に入りトグル
  - ON で `favorite=1` を URL に付与し、OFF で削除する

---
