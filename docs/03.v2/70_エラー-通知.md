---
title: 70. エラー-通知（設計書V2）
source:
author:
  -
published:
created: 2026-01-30
description:
tags:
---

本ファイルは設計書V1（アーカイブ済み）から、エラーハンドリング/通知に関する章を分割したもの。

## この章で決めること

- エラー種別の分類と、UI（トースト/アラート等）への対応方針
- 代表ステータス（401/403/404/422/500 等）の扱い
- 開発環境でのエラー再現（シミュレーション）方針

## この章の守備範囲

- エラーを「どう通知するか」「状態を維持するか」などの方針を扱う
- 個別機能の実装詳細は扱わない（各機能章を参照）

## 関連ドキュメント（参照先）

- 文言: `docs/06. テキスト・コンテンツ定義.md`
- 認証/認可（401/403等）: `docs/03.v2/20_認証-認可-スタブ.md`

# エラーハンドリング: エラー通知実装設計

## エラー種別

各機能実行時には適切なエラーハンドリングを行い、必要に応じてユーザーにフィードバックする。

- 認証エラー：ログインが必要な操作で未認証の場合
- 認可エラー：権限のない操作を試みた場合
- Not Found エラー：対象のリソースが存在しない場合
- バリデーションエラー：入力値が不正な場合
- サーバーエラー：サーバー側で予期せぬエラーが発生した場合
- 一般的なエラー：上記に分類されないエラー
- 成功メッセージ：操作が正常に完了した場合

エラーや成功メッセージはsonnerで表示し、ユーザーが現在の状態を理解できるようにする。

## UI対応表

認証/認可/Not Found などのエラーは、HTTP ステータス（またはドメインエラー）から UI の振る舞いを一意に決める。
文言は `docs/06.テキスト・コンテンツ定義.md` を正とし、内部情報（例: 例外メッセージ/スタックトレース）は表示しない。

**ログインモーダルを自動表示する対象（ログイン必須操作）**:
- 投稿: 保存/更新/ごみ箱投入/復元/削除/完全削除
- 絞り込み: タグの追加/解除、お気に入りON/OFF
- 一覧: 無限スクロールの追加取得（セッション切れも想定して扱う）

| ケース | 代表ステータス | sonner（種別） | 表示文言 | UI挙動 | 再試行導線 |
| --- | --- | --- | --- | --- | --- |
| ログイン（OAuth）失敗/キャンセル | - | `toast.error` | 「認証エラーが発生しました」 | ログインモーダルは閉じる。状態は未ログインのまま | 再度ログイン操作（ログインボタン→モーダル→「Googleでログイン」） |
| 未認証（セッション切れ/未ログイン） | 401 | `toast.error` | 「ログインが必要です」 | **入力/画面状態は維持**し、ログインモーダルを自動で開く（MVP はベストエフォート）。この時点では `router.refresh()` 等で強制的に未ログイン画面へ切り替えない | ログイン成功後にユーザーが同操作を再実行（初期は自動リトライしない） |
| 認可（権限なし） | 403 | `toast.error` | 「権限がありません」 | 状態維持。必要なら該当データを再取得して整合を取る | 操作の再実行 |
| Not Found（対象なし/他人の投稿等） | 404 | `toast.error` | 「対象が見つかりません」 | 状態維持。編集/選択中の対象が消えた場合は編集解除し、一覧を再取得する | なし（再取得で整合） |
| バリデーション（入力不備） | 422 | （sonner ではなく Alert） | 「入力内容に不備があります」/「内容を入力してください」/「内容は最大280文字までです」/「内容は最大20000文字までです」/「タグは最大10件まで追加できます」 | Alert を表示し、入力状態は維持する | 入力修正→再実行 |
| サーバー/通信 | - / 5xx | `toast.error` | 「サーバーエラーが発生しました」/「エラーが発生しました」 | 状態維持（操作の途中状態を捨てない） | 必要に応じて「再試行」アクション（同操作の再実行）を提供する |

※補足: Auth.js（Google OAuth）の再ログインはリダイレクトが発生し得るため、MVP では未保存入力の完全な保持は保証しない。将来「下書きの自動保存/復元」（`sessionStorage` / `localStorage`）で改善する（要件: `docs/01.要件定義書.md`）。

## 開発環境用エラーシミュレーション

- 開発環境のみ有効なエラー通知シミュレーション機能を実装する
- 実装方針
  - クエリパラメータ `errorTest` を監視し、値に応じて対応するsonner通知を表示する
    - `http://localhost:3000/?errorTest=auth` → 認証エラー
    - `http://localhost:3000/?errorTest=authorization` → 認可エラー
    - `http://localhost:3000/?errorTest=notfound` → Not Found エラー
    - `http://localhost:3000/?errorTest=validation` → バリデーションエラー
    - `http://localhost:3000/?errorTest=server` → サーバーエラー
    - `http://localhost:3000/?errorTest=generic` → 一般的なエラー
    - `http://localhost:3000/?errorTest=success` → 成功メッセージ
  - sonner通知表示後、`errorTest` クエリパラメータを URL から削除し、リロードしても再発火しないようにする
  - `process.env.NODE_ENV === "production"` の場合、この機能は無効化する
- 実装場所
  - クライアントコンポーネントまたは `useEffect` 相当のカスタムフックで URL を監視し、sonner通知表示とパラメータ削除を行う

---
