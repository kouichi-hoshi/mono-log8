---
title: 80. DBモデル（設計書V2）
source:
author:
  -
published:
created: 2026-01-30
description:
tags:
---

本ファイルは設計書V1（アーカイブ済み）から、DBモデル設計に関する章を分割したもの。

## この章で決めること

- DBモデル（User/Post/Tag/PostTag）の構造と主要カラム
- 投稿一覧を成立させるための最小インデックス設計
- DB運用手順（migration等）は別ドキュメントで扱う（本章は構造の設計のみ）

## この章の守備範囲

- テーブル/カラム/インデックスなど「DB構造」を扱う
- 運用手順（migration適用、CI/デプロイ手順等）は扱わない

## 関連ドキュメント（参照先）

- 運用手順（CI・デプロイ）: `docs/07.運用手順（CI・デプロイ）.md`

# データモデル設計（DB）

## User テーブル

- `id`: ユーザーの主キー（String）
- `posts`: ユーザーが作成した Post との 1 対多リレーション
- `createdAt`: 作成日時（自動付与）
- `updatedAt`: 更新日時（変更時に自動更新）

> 補足: Google OAuth 接続では `googleSub` / `email` / `name` 等のユーザー識別・表示に必要な属性を追加する。文字サイズ（`fontScale`）などのユーザー設定も、必要になった段階でテーブルに追加する。

## Post テーブル

- `postId`: 投稿の主キー（String、`cuid()`）
- `authorId`: 投稿者の `User.id` への外部キー
- `author`: User へのリレーション
- `content`: 投稿本文（tiptap / ProseMirror の doc JSON。PostgreSQL `jsonb`、Prisma では `Json` を想定）
- `contentText`: 投稿本文の抽出テキスト（一覧プレビュー/将来の全文検索用）
- `status`: 投稿の状態
  - `active`: 通常の投稿
  - `trashed`: ごみ箱に入っている状態
- `mode`: 投稿の種類（`memo` / `note`）。一覧の絞り込みに使用
- `favorite`: お気に入りフラグ（boolean、default false）
- `createdAt`: 作成日時（自動付与）
- `updatedAt`: 更新日時（変更時に自動更新）
- `trashedAt`: ごみ箱移動日時（ソフト削除の指標。復元で `null` に戻す）

### インデックス設計（投稿一覧のみ）

投稿一覧（通常/ごみ箱）の追加取得を安定して高速化するため、**Post テーブルに限って**必要最小限のインデックスを設計する。

**対象となる取得パターン（例）**:
- 通常一覧: `authorId` + `status=active` + `mode` で絞り込み、`createdAt DESC, postId DESC` で並び替え、`limit` 件ずつ追加取得（cursor）
- ごみ箱一覧: `authorId` + `status=trashed` で絞り込み、`trashedAt DESC, postId DESC` で並び替え、`limit` 件ずつ追加取得（cursor）

**インデックス（投稿一覧のみ / 最小）**:
- 通常一覧（`status=active` + `mode` 絞り込み）向け
  - `Post(authorId, status, mode, createdAt, postId)`（並び順は `createdAt DESC, postId DESC` を想定）
  - 投稿一覧の「絞り込み + 並び替え + cursor」に対応する
- ごみ箱一覧（`status=trashed`、mode で絞らない）向け
  - `Post(authorId, status, trashedAt, postId)`（並び順は `trashedAt DESC, postId DESC` を想定）
  - `status` + `trashedAt` の並びで追加取得できるようにする

**補足**:
- ごみ箱一覧の並び順は `trashedAt DESC` を採用する
- タグ/お気に入り絞り込み（Join/追加条件が増えるケース）のインデックスは、本設計では対象外とし、導入フェーズで計測してから設計する
- タグ/お気に入り絞り込み（Join/追加条件が増えるケース）のインデックスは、本設計では対象外とし、実導入後に計測してから設計する

## Tag テーブル

- `tagId`: タグの主キー（String、`cuid()`）
- `ownerId`: `User.id` への外部キー。ユーザーごとのカスタムタグを管理する
- `label`: タグ名（保存時に正規化し最大 32 文字、大小文字は区別する。ユニーク制約は `ownerId` + `label` の組み合わせに付与）
- `createdAt` / `updatedAt`

## PostTag テーブル（中間）

- `postId`: Post への外部キー
  - Post を完全削除（物理削除）した場合、PostTag は必ず削除される（推奨: FK `ON DELETE CASCADE`）
- `tagId`: Tag への外部キー
  - Tag は未使用でも自動削除しない（MVP）。Tag の物理削除を行う場合は別途手順を定義する
- `sortOrder`: タグ表示順を将来的に制御するための数値（デフォルト 0）
- 複合ユニーク制約: (`postId`, `tagId`)


---
