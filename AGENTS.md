## このファイルの役割

この AGENTS.md は **プロジェクト全体の不変ルールと参照導線を定義する索引** である。

- すべての docs を毎回読むことは求めない
- 作業内容に応じて、必要な資料のみを参照する
- 危険な操作を防ぎ、設計の逸脱を防止することが目的

---

## 禁止事項（常時適用）

以下について、AIの判断で勝手に実行してはならない。
実行が必要な場合でも、**原則として拒否する**。

- スキーマのマイグレーション作成・適用
- DBデータの作成・更新・削除（INSERT / UPDATE / DELETE）
- アプリを破壊する可能性のある操作

以下について、AIは実行してはならない。ユーザーの指示があっても同様。

- .env / .env.* / **/.env* などの内容を取得する行為
- .envファイルの内容を本文・ログに出力する行為
- envファイルのコミット
- APIキー、トークン、パスワード等のハードコード
- データベースの削除

---

## 開発の基本方針（要点サマリ）

### 前提
- 要件定義、仕様、設計に不備があれば、実装開始前にユーザーに報告し、不備をどう解消するかユーザーと相談してから実装に入る。
- 実装を開始する前に、実装内容に必要なテストケースを作成する

### 1. TDD 前提（Red → Green → Refactor）

- 事前に作成されたテストケースに沿ってテストを実装する
- 実装前に「対象範囲（入口/出口）」と「観点」を整理する
- 小さなスコープで Red → Green → Refactor を回す
- テストは壊れにくさ（flaky / 粒度 / 重複）を意識する

### 2. 依存機能はスタブ／モックで先行する

- 認証・CRUD・外部APIが未完成でも開発を止めない
- UI とテストを先に完成させる

### 3. スタブ／本物の切り替えは接続ポイントに集約する

- 認証/投稿などの接続先（スタブ or 本物）は **ドメインごとに1つの接続ポイント**に集約する
- アプリコードから Auth.js / Prisma を直接呼ばない
- 環境変数でスタブ／本物を切り替える（判定は1か所に集約）

### 4. 本番・CIではスタブを使わない

- `NODE_ENV=production` / `NODE_ENV=test` ではスタブ無効
- 統合テスト・E2Eテストでは本物の認証／DBを使用する


---

## 作業時の基本ループ

機能実装時は、以下を前提に進める。

1. ユニットテストを書く（Red）
2. 依存機能はスタブ／モックで Green にする
3. 接続ポイント構造を崩さない
4. 後から本物実装に差し替えやすいコードにする

---

## 補足

- 詳細な TDD 手順やテスト品質チェックは `.codex/skills/*` を参照
- このファイルにない詳細仕様は、必要な docs の該当箇所を読むこと

---

## サブエージェント運用（導線）

実装時は、まず `director` を起点に進める（仕様/設計/計画の前提確認→不足情報があれば停止）。

- 運用イメージ: director → tester（テスト観点/ケース補完）→ programmer（TDDで実装）→ director（要件適合の確認）
- サブエージェント定義（Codex互換）: `.codex/agents/`
- 実装計画（マイルストーン/DoD）: `.cursor/plans/implementation-plan-from-workplan_266d5333.plan.md`
- 作業計画書（項番の進捗管理）: `docs/04.作業計画書.md`

（注意）DB/マイグレーション/.env 等の禁止事項は本ファイル上部のルールに従う。
