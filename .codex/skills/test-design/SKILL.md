---
name: test-design
description: テストケース設計（観点洗い出し・優先順位付け・単体/結合/E2Eへの配分・チェックリストIDとの紐づけ）を行うための手順。
---

## 目的

- 要件から **テストすべき振る舞い** を漏れなく抽出し、適切なテストレベル（単体/結合/E2E）に配分する
- 実装の前に「何を保証するか」を言語化して **TDD（Red→Green→Refactor）** を回しやすくする
- `docs/05. 作業計画進行チェックリスト.md` とテストのトレーサビリティを維持する（ID ↔ テスト名）

## 参照必須（このリポジトリの一次資料）

- **ドキュメント参照ルール**は `AGENTS.md` に従う（作業内容に応じて、必要な docs の該当箇所のみ参照する）
- テスト設計で迷ったら、まず `docs/03. 設計書.md`（設計/テスト戦略）と `docs/05. 作業計画進行チェックリスト.md`（タスク運用）を確認する

## いつ使うか（When to Use）

- 新機能/改修の着手前に、まず **落ちるテスト（Red）** を設計したいとき
- 「単体テストは書けるが、何をテストすべきか」が曖昧なとき
- 既存の不具合の再発防止として、**最小の回帰テスト** を決めたいとき
- フェーズ切替（スタブ → 本番）や、統合/E2E の範囲決めが必要なとき

## 成果物（Outputs）

- **テスト観点表（観点→ケース→期待結果）**
- **テストレベル配分表（単体/結合/E2Eのどれで担保するか）**
- **優先順位付きのテスト実装バックログ**（`docs/05` の ID と紐づける）
- 必要に応じて **受け入れ条件（Given/When/Then）** の箇条書き

## 手順（Instructions）

### 0. スコープ確定（3分）

- 対象機能の入口/出口を1文で定義する
  - 例: 「投稿エディタで保存を押すと、未入力ならAlert、入力ありなら作成されトースト表示、入力欄がクリアされる」
- “やらないこと” を明記する（フェーズ外、未対応ブラウザ、非対応デバイス等）

### 1. 仕様の真実を決める（Single Source of Truth）

- 表示文言: `docs/06` が真実（UIテキストの期待はここに合わせる）
- 画面/導線: `docs/02` と `docs/03` を優先
- Done定義/進め方: `docs/04` と `docs/05` を優先

### 2. 観点カタログでケースを洗い出す（漏れ防止）

下の観点を **該当するものだけ** チェックし、ケース案を1行で列挙する。

- 機能要件（ハッピーパス）
- 入力バリデーション（空/境界/不正）
- 状態遷移（新規→更新→削除→復元、表示モード切替など）
- 表示分岐（未ログイン/ログイン、`mode/view/sort` のクエリ連動、レスポンシブ）
- エラー（失敗時のUI、トースト、リトライ、状態維持）
- 非同期/並行（連打・二重送信・同時操作）
- 永続化/復元（リロード、戻る/進む、キャッシュ整合）
- アクセシビリティ（role/label、キーボード操作、Escape/外側クリック）
- セキュリティ/ガード（本番でスタブが有効にならない等）

### 3. テストレベルに配分する（単体/結合/E2E）

このプロジェクト方針に合わせて配分する。

- **単体（Jest/RTL）**
  - UIの表示/操作/コールバック、純粋関数、接続ポイントの振る舞い
  - 依存は `jest.mock()` で差し替え、スタブ/モックでGREENにする
- **結合（統合）**
  - 「認証＋Server Action＋DB＋UI」などの連携を担保する（スタブは使わない方針）
- **E2E**
  - 重要導線の回帰（例: ログイン→投稿→ゴミ箱→復元）をブラウザ操作で担保

原則:
- 仕様の中心は単体で速く回す
- “つなぎ目” と “本物への差し替え保証” を結合/E2Eに寄せる

### 4. 優先順位をつける（最初に守る回帰点を決める）

各ケースに以下を付与して並べ替える。

- Impact（影響）: High / Mid / Low
- Frequency（頻度）: High / Mid / Low
- Detectability（検知容易性）: Easy / Hard

最初に実装するのは原則 **Impact High × Frequency High**。

### 5. ケースを「1テスト=1仕様」に落とす（Given/When/Then）

- テスト名は「何ができるか」を日本語で明確に
- 可能なら `docs/05` の ID を併記（例: `（P1-EDIT-04）`）
- 依存が未完成でも止めない（接続ポイントを mock して GREEN へ）

### 6. チェックリスト（docs/05）へ反映する

- 新しいテストが必要なら `docs/05` にタスクを追加
- 完了条件に「どのテストがGREENか」を記載してトレーサビリティを確保

## テンプレ（コピペ用）

### テスト観点表（最小）

```text
対象:
仕様の真実（参照）:

観点 | ケース | 期待結果 | レベル（単体/結合/E2E） | 優先度
--- | --- | --- | --- | ---
ハッピーパス | | | |
バリデーション | | | |
状態遷移 | | | |
表示分岐 | | | |
エラー | | | |
非同期/並行 | | | |
永続化/復元 | | | |
```

### Given/When/Then（最小）

```text
Given: 前提（状態/データ/URL/ログイン）
When: 操作（クリック/入力/保存など）
Then: 期待（表示/呼び出し/URL/キャッシュ/トースト）
```

## 注意事項（プロジェクトルール）

- 本番でスタブが有効にならないこと（`NODE_ENV=production` ガード）を前提に設計する
- テストのために DB を破壊する操作（削除/更新/マイグレーション等）を勝手に行わない（`AGENTS.md` 準拠）
