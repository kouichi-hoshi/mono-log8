---
name: test-quality
description: テストそのものの品質（壊れにくさ・無駄の排除・意味の明確化・重複防止・設計へのフィードバック）を担保するための手順とチェックリスト。
---

## 目的

- テストが **壊れにくい（flakyになりにくい）** 状態を維持する
- テストが **無駄に多くならず、重複せず、意味のある仕様保証** になるようにする
- テストが **設計改善（境界/依存/責務）** にフィードバックできる運用にする
- 必要なタイミングで、必要なテストだけを追加できる判断基準を持つ

## 参照必須（このリポジトリの一次資料）

- 開発方針/禁止事項: `AGENTS.md`
- 設計/テスト戦略: `docs/03. 設計書.md`
- 作業運用/トレーサビリティ: `docs/05. 作業計画進行チェックリスト.md`
- テスト設計（何をテストするか）: `.codex/skills/test-design/SKILL.md`

## このSkillのスコープ

- 対象: **Jest/RTLの単体テスト**、（将来の）統合テスト、（将来の）E2E の「品質」
- 非対象: 仕様そのものの決定（それは `test-design` の責務）

## 成果物（Outputs）

- 品質チェックリストの適用結果（満たす/未対応/理由）
- 必要なら「改善タスク」への分解（`docs/05` に紐づけ）
- 設計改善メモ（テスト容易性の観点でのリファクタ提案）

## 原則（短く覚える）

- **テストピラミッド**: 単体を厚く、結合は“つなぎ目”、E2Eは“重要導線”に絞る
- **1テスト=1仕様**: 失敗したとき「何が壊れたか」が1行で分かる
- **壊れにくさ優先**: 不安定なテストは価値を毀損する（flakyは負債）
- **重複は悪**: 同じ仕様を別レベルで二重に守らない（必要な場合は理由を書く）
- **設計へ逆流**: テストが書きにくいなら、まず設計/境界を疑う

## 手順（Instructions）

### 実行宣言

「test-quality Skillを実行します」と宣言し、対象（PR/機能/テスト群）を一文で書く。

### 0. “品質の失敗モード” を先に洗い出す（3分）

該当するものにチェックして、対策方針を決める。

- flaky（タイミング依存・非決定的）
- 速度劣化（遅い、無駄なレンダリング、重いセットアップ）
- 重複（同じ保証が複数箇所にある）
- 意味が曖昧（テスト名/期待が仕様になっていない）
- 保守困難（セットアップ過多、密結合、テストが実装詳細に寄りすぎ）

### 1. 品質チェックリスト（書く/直すたびに適用）

#### A. 意味・粒度（Meaning）

- [ ] テスト名が「何ができるか（仕様）」を表している（日本語で具体）
- [ ] 1テストで検証する仕様が1つに収まっている（失敗原因が一意）
- [ ] 実装詳細ではなく、ユーザー観点の振る舞いを見ている（UIなら role/name 等）
- [ ] 例外: 実装詳細を見ている場合、その理由がある（性能/境界/副作用など）

#### B. 重複・無駄（No waste / No duplication）

- [ ] 同じ仕様を単体と統合/E2Eで二重に守っていない
- [ ] コンポーネント単体で十分なら、UiPlayground系のテストで同じことを再検証しない
- [ ] 「確認のためのテスト」ではなく「壊れたら困る仕様」だけを残す
- [ ] 将来E2Eで守るべき導線は、単体では“分岐/バリデーション”等に寄せている

#### C. 安定性（Flake resistance）

- [ ] `setTimeout` 前提の待ちをしない（必要なら `findBy` / `waitFor`）
- [ ] 競合しやすいグローバル状態（Date/Math.random/Intl等）を固定している（必要時）
- [ ] 外部I/O（fetch/DB/認証）はテスト境界でモック/スタブ化している（方針に従う）
- [ ] Portal/アニメーション等で揺れる要素は、安定した観測点（role/name/label）で見る

#### D. 速度（Fast feedback）

- [ ] セットアップが最小（共通化しすぎて読めない状態になっていない）
- [ ] 重い統合相当の確認を単体に持ち込んでいない
- [ ] 同一のrender/操作が過剰に繰り返されていない（必要ならヘルパ化）

#### E. 設計へのフィードバック（Design feedback）

- [ ] テストが書きにくい箇所を記録した（依存注入、接続ポイント集約、純粋関数化など）
- [ ] 改善が必要ならタスク化し、`docs/05` のIDと紐づける（後回しでも可）
- [ ] 「モックが複雑すぎる」＝設計が複雑のサインとして扱った

### 2. “追加するタイミング” の判断基準

- **追加する**
  - 重大（Impact高）かつ発生頻度が高い
  - 過去に壊れた/壊れやすい境界（認証、接続ポイント、状態遷移）
  - 修正が入り続ける領域（仕様が動く・リファクタ頻発）
- **追加しない/削る**
  - 同じ保証が別レベルで既に守られている
  - 実装詳細追従でしか維持できない
  - flakyで直すコストが価値を上回る（直せないなら削除/縮小）

### 3. 報告と許可（運用）

- 品質チェックの結果を短く共有する（OK/懸念/追加タスク）
- 必要なら、追加テストやリファクタの着手についてユーザーの許可を得る（`AGENTS.md` 準拠）

## テンプレ（コピペ用）

### 品質レビュー（最小）

```text
対象:
結論（OK/要改善）:

- Meaning:
- No waste / No duplication:
- Flake resistance:
- Fast feedback:
- Design feedback:

追加タスク（必要なら docs/05 に紐づけ）:
-
```

## 注意事項（プロジェクトルール）

- DBを破壊する操作（削除/更新/マイグレーション等）は勝手に行わない（`AGENTS.md` 準拠）
- スタブ/本物の切替は接続ポイントに集約し、環境変数と本番ガードを守る（`AGENTS.md` 準拠）
